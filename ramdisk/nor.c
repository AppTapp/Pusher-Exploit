#include <stdint.h>
#include <IOKit/IOKitLib.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sys/mman.h>

typedef enum {
	FlashLLB = 0,
	FlashImage = 1
} FlashMode;

typedef struct FlashInfo {
	void*		data;
	uint32_t	length;
	FlashMode	mode;
	int		filedes;
} FlashInfo;

IOReturn flashNOR(io_connect_t conn, void* data, uint32_t length, FlashMode mode) {
	return IOConnectCallStructMethod(conn, mode, data, length, NULL, 0);
}

void doFlash(FlashInfo* toFlash) {
	IOReturn ret;

	CFMutableDictionaryRef dict = IOServiceMatching("AppleImage3NORAccess");
	io_service_t dev = IOServiceGetMatchingService(kIOMasterPortDefault, dict);
	io_connect_t conn = 0;

	if(!dev) {
		printf("error: AppleImage3NORAccess device not found!\n");
		fflush(stdout);
		goto quit;
	}

	ret = IOServiceOpen(dev, mach_task_self(), 0, &conn);

	if(ret != kIOReturnSuccess) {
		printf("error: Cannot open service\n");
		fflush(stdout);
		goto quit;
	}

	size_t totalSize = 0;
	FlashInfo* flashList = toFlash;
	while(flashList->data != NULL) {
		totalSize += flashList->length;
		flashList++;
	}

	while(toFlash->data != NULL) {
		ret = flashNOR(conn, toFlash->data, toFlash->length, toFlash->mode);
		if (ret)
		{
			printf("f(-_-)n returned %x\n", ret);
			fflush(stdout);
		}
		//CurrentUnits += FlashUnits * (float)(((float)toFlash->length)/((float)totalSize));
		//IncrementProgressTo(CurrentUnits, TotalUnits);
		toFlash++;
	}

quit:

	if(conn)
		IOServiceClose(conn);

	if(dev)
		IOObjectRelease(dev);

}

int getFile(FlashInfo* info, const char* fileName) {
	struct stat fileStat;
	int filedes = -1;
	void* buffer = NULL;

	if(stat(fileName, &fileStat) < 0)
		return -1;

	filedes = open(fileName, O_RDONLY);
	if(filedes < 0)
		goto file_err;

	info->data = mmap(NULL, fileStat.st_size, PROT_READ | PROT_WRITE, MAP_ANON | MAP_PRIVATE, -1, 0);
	if(!info->data)
		goto file_err;

	buffer = mmap(NULL, fileStat.st_size, PROT_READ, MAP_PRIVATE, filedes, 0);
	if(!buffer)
		goto file_err;

	memcpy(info->data, buffer, fileStat.st_size);
	munmap(buffer, fileStat.st_size);
	info->length = fileStat.st_size;
	info->filedes = filedes;

	return 0;

file_err:
	if(buffer)
		munmap(buffer, fileStat.st_size);

	if(info->data)
		munmap(info->data, fileStat.st_size);

	if(filedes >= 0)
		close(filedes);

	return -1;
}

int flashManifest(const char* manifestFile) {
	FlashInfo info[20];
	char fileName[256];
	FILE* manifest;
	//int beforeUnits = CurrentUnits;

	manifest = fopen(manifestFile, "r");

	int curImage = 0;
	while(fgets(fileName, sizeof(fileName), manifest)) {
		fileName[strlen(fileName) - 1] = '\0';

		if(fileName[0] == '\0')
			continue;

		if(getFile(&info[curImage], fileName) < 0) {
			printf("error: could not load %s\n", fileName);
			fflush(stdout);
			return 1;
		}

		if(curImage == 0)
			info[curImage].mode = FlashLLB;
		else
			info[curImage].mode = FlashImage;

		curImage++;
	}

	fclose(manifest);

	info[curImage].data = NULL;

	doFlash(info);

	curImage = 0;
	while(info[curImage].data) {
		munmap(info[curImage].data, info[curImage].length);
		close(info[curImage].filedes);
		curImage++;
	}

	//CurrentUnits = beforeUnits + FlashUnits;
	//IncrementProgressTo(CurrentUnits, TotalUnits);

	return 0;
}
