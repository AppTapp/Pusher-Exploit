#include <unistd.h>
//#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <ftw.h>

#include <sys/stat.h>
#include <sys/utsname.h>

//#include <sys/sysctl.h>

#include <CoreFoundation/CoreFoundation.h>

void tweakDpkgInstall_(char* filename, char* fullInfo, char* packageTag, char* version);
void tweakDpkgInstall(char* version);
void cleanup();
char* firmwareVersion();
void fileCopy(const char* orig, const char* dest);

int main(int argc, char *argv[], char *env[])
{
	tweakDpkgInstall(firmwareVersion());
	cleanup();
	return 0;
}

char* firmwareVersion()
{
	CFPropertyListRef propertyList;
	CFStringRef errorString;
	CFURLRef url;
	CFDataRef resourceData;
	Boolean status;
	SInt32 errorCode;
	char* version;

	url = CFURLCreateWithFileSystemPath(kCFAllocatorDefault, CFSTR("/System/Library/CoreServices/SystemVersion.plist"), kCFURLPOSIXPathStyle, false);

	status = CFURLCreateDataAndPropertiesFromResource(
			kCFAllocatorDefault,
			url,
			&resourceData,
			NULL,
			NULL,
			&errorCode);

	propertyList = CFPropertyListCreateFromXMLData( kCFAllocatorDefault,
							resourceData,
							kCFPropertyListImmutable,
							&errorString);

	CFRelease(url);
	CFRelease(resourceData);

	version = strdup(CFStringGetCStringPtr(CFDictionaryGetValue(propertyList, CFSTR("ProductVersion")), CFStringGetSystemEncoding()));

	CFRelease(propertyList);

	return version;
}

#if defined(TEST)
	#define FIRMWARE_LIST_FILE "firmware.list"
	#define DPKG_LIST_FILE "dpkg.list"
	#define ICY_LIST_FILE "com.ripdev.icy.list"
#else
	#define FIRMWARE_LIST_FILE "/var/lib/dpkg/info/firmware.list"
	#define DPKG_LIST_FILE "/var/lib/dpkg/info/dpkg.list"
	#define ICY_LIST_FILE "/var/lib/dpkg/info/com.ripdev.icy.list"
#endif

void tweakDpkgInstall(char* version)
{
	char* fullStatusInfo = "Package: dpkg\nEssential: yes\nStatus: install ok installed\nPriority: required\nSection: Packaging\nInstalled-Size: 2604\nMaintainer: Ripdev <support@ripdev.com>\nArchitecture: iphoneos-arm\nVersion: 1.14.25\nDepends: bash, bzip2, coreutils, diffutils, findutils, gzip, ncurses, tar\nDescription: package maintainance tools from Debian\nName: Debian Packager\n\n";
	char* fullAvailInfo = "Package: dpkg\nEssential: yes\nPriority: required\nSection: Packaging\nInstalled-Size: 2604\nMaintainer: Ripdev <support@ripdev.com>\nArchitecture: iphoneos-arm\nVersion: 1.14.25\nDepends: bash, bzip2, coreutils, diffutils, findutils, gzip, ncurses, tar\nDescription: package maintainance tools from Debian\nName: Debian Packager\n\n";
	
	char* firmwareStatusFormat = "Package: firmware\nEssential: yes\nStatus: install ok installed\nPriority: required\nSection: System\nInstalled-Size: 0\nMaintainer: Ripdev <support@ripdev.com>\nArchitecture: iphoneos-arm\nVersion: %s\nDescription: iPhone OS\nName: iPhone Firmware\n\n";
	char* firmwareAvailFormat = "Package: firmware\nEssential: yes\nPriority: required\nSection: System\nInstalled-Size: 0\nMaintainer: Ripdev <support@ripdev.com>\nArchitecture: iphoneos-arm\nVersion: %s\nDescription: iPhone OS\nName: iPhone Firmware\n\n";
	
	char* icyStatusFormat = "Package: com.ripdev.icy\nStatus: install ok installed\nPriority: required\nSection: Packaging\nInstalled-Size: 0\nMaintainer: Ripdev <support@ripdev.com>\nArchitecture: iphoneos-arm\nVersion: 1.4.1-3749\nDescription: Icy: free faster alternative to Cydia\nName: Icy\n\n";
	char* icyAvailFormat = "Package: com.ripdev.icy\nPriority: required\nSection: Packaging\nInstalled-Size: 0\nMaintainer: Ripdev <support@ripdev.com>\nArchitecture: iphoneos-arm\nVersion: 1.4.1-3749\nDescription: Icy: free faster alternative to Cydia\nName: Icy\n\n";

	char buffer[8192];
	char versionBuffer[255];
	sprintf(versionBuffer, "Version: %s\n", version);

#if defined(TEST)
	tweakDpkgInstall_("status", fullStatusInfo, "Package: dpkg", "Version: 1.14.25\n");
	tweakDpkgInstall_("available", fullAvailInfo, "Package: dpkg", "Version: 1.14.25\n");
	
	tweakDpkgInstall_("status", icyStatusFormat, "Package: com.ripdev.icy", "Version: 1.4.1-3749\n");
	tweakDpkgInstall_("available", icyAvailFormat, "Package: com.ripdev.icy", "Version: 1.4.1-3749\n");

	sprintf(buffer, firmwareStatusFormat, version);
	tweakDpkgInstall_("status", buffer, "Package: firmware", versionBuffer);
	
	sprintf(buffer, firmwareAvailFormat, version);
	tweakDpkgInstall_("available", buffer, "Package: firmware", versionBuffer);
	
#else
	tweakDpkgInstall_("/var/lib/dpkg/status", fullStatusInfo, "Package: dpkg", "Version: 9.99.99\n");
	tweakDpkgInstall_("/var/lib/dpkg/available", fullAvailInfo, "Package: dpkg", "Version: 9.99.99\n");

	sprintf(buffer, firmwareStatusFormat, version);
	tweakDpkgInstall_("/var/lib/dpkg/status", buffer, "Package: firmware", versionBuffer);
	
	sprintf(buffer, firmwareAvailFormat, version);
	tweakDpkgInstall_("/var/lib/dpkg/available", buffer, "Package: firmware", versionBuffer);
#endif

	struct stat st;
	
	if (stat(FIRMWARE_LIST_FILE, &st))
	{
		FILE* firmwareFile = fopen(FIRMWARE_LIST_FILE, "w");
		
		if (firmwareFile)
		{
			fprintf(firmwareFile, "/.\n");
			fclose(firmwareFile);
		}
	}
	
	if (stat(DPKG_LIST_FILE, &st))
	{
		FILE* firmwareFile = fopen(DPKG_LIST_FILE, "w");
		
		if (firmwareFile)
		{
			fprintf(firmwareFile, "/.\n/usr\n/usr/bin\n/usr/bin/dpkg\n/usr/bin/dpkg-deb\n/usr/bin/dpkg-query\n/usr/bin/dpkg-split\n/usr/sbin\n/usr/sbin/install-info\n/var\n/var/lib\n/var/lib/dpkg\n/var/lib/dpkg/alternatives\n/var/lib/dpkg/info\n/var/lib/dpkg/parts\n/var/lib/dpkg/updates\n");
			fclose(firmwareFile);
		}
	}

	if (stat(ICY_LIST_FILE, &st))
	{
		FILE* firmwareFile = fopen(ICY_LIST_FILE, "w");
		
		if (firmwareFile)
		{
			fprintf(firmwareFile, "/Applications\n/Applications/Icy.app\n/Applications/Icy.app/_CodeSignature\n/Applications/Icy.app/_CodeSignature/CodeResources\n/Applications/Icy.app/About.png\n/Applications/Icy.app/ButtonSmall.png\n/Applications/Icy.app/Categories.png\n/Applications/Icy.app/Category.png\n/Applications/Icy.app/da.lproj\n/Applications/Icy.app/da.lproj/Localizable.strings\n/Applications/Icy.app/da.lproj/MainWindow.nib\n/Applications/Icy.app/DatabaseSchema.plist\n/Applications/Icy.app/de.lproj\n/Applications/Icy.app/de.lproj/Categories.strings\n/Applications/Icy.app/de.lproj/CategoriesReverse.strings\n/Applications/Icy.app/de.lproj/Localizable.strings\n/Applications/Icy.app/de.lproj/MainWindow.nib\n/Applications/Icy.app/Default.png\n/Applications/Icy.app/Done.caf\n/Applications/Icy.app/DottyBackground.png\n/Applications/Icy.app/el.lproj\n/Applications/Icy.app/el.lproj/Categories.strings\n/Applications/Icy.app/el.lproj/CategoriesReverse.strings\n/Applications/Icy.app/el.lproj/Localizable.strings\n/Applications/Icy.app/el.lproj/MainWindow.nib\n/Applications/Icy.app/embedded.mobileprovision\n/Applications/Icy.app/English.lproj\n/Applications/Icy.app/English.lproj/Categories.strings\n/Applications/Icy.app/English.lproj/CategoriesReverse.strings\n/Applications/Icy.app/English.lproj/Localizable.strings\n/Applications/Icy.app/English.lproj/MainWindow.nib\n/Applications/Icy.app/es.lproj\n/Applications/Icy.app/es.lproj/Categories.strings\n/Applications/Icy.app/es.lproj/CategoriesReverse.strings\n/Applications/Icy.app/es.lproj/Localizable.strings\n/Applications/Icy.app/es.lproj/MainWindow.nib\n/Applications/Icy.app/fr.lproj\n/Applications/Icy.app/fr.lproj/Categories.strings\n/Applications/Icy.app/fr.lproj/CategoriesReverse.strings\n/Applications/Icy.app/fr.lproj/Localizable.strings\n/Applications/Icy.app/fr.lproj/MainWindow.nib\n/Applications/Icy.app/GradientBackground.png\n/Applications/Icy.app/GradientBackgroundLarge.png\n/Applications/Icy.app/GradientBackgroundLarge_BottomCap.png\n/Applications/Icy.app/GradientBackgroundLarge_TopCap.png\n/Applications/Icy.app/he.lproj\n/Applications/Icy.app/he.lproj/Categories.strings\n/Applications/Icy.app/he.lproj/CategoriesReverse.strings\n/Applications/Icy.app/he.lproj/Localizable.strings\n/Applications/Icy.app/he.lproj/MainWindow.nib\n/Applications/Icy.app/Icy\n/Applications/Icy.app/IcyIcon.png\n/Applications/Icy.app/Info.plist\n/Applications/Icy.app/Installed.png\n/Applications/Icy.app/it.lproj\n/Applications/Icy.app/it.lproj/Categories.strings\n/Applications/Icy.app/it.lproj/CategoriesReverse.strings\n/Applications/Icy.app/it.lproj/Localizable.strings\n/Applications/Icy.app/it.lproj/MainWindow.nib\n/Applications/Icy.app/nl.lproj\n/Applications/Icy.app/nl.lproj/Categories.strings\n/Applications/Icy.app/nl.lproj/CategoriesReverse.strings\n/Applications/Icy.app/nl.lproj/Localizable.strings\n/Applications/Icy.app/nl.lproj/MainWindow.nib\n/Applications/Icy.app/Package.png\n/Applications/Icy.app/PkgInfo\n/Applications/Icy.app/pl.lproj\n/Applications/Icy.app/pl.lproj/Categories.strings\n/Applications/Icy.app/pl.lproj/CategoriesReverse.strings\n/Applications/Icy.app/pl.lproj/Localizable.strings\n/Applications/Icy.app/pl.lproj/MainWindow.nib\n/Applications/Icy.app/pt.lproj\n/Applications/Icy.app/pt.lproj/Categories.strings\n/Applications/Icy.app/pt.lproj/CategoriesReverse.strings\n/Applications/Icy.app/pt.lproj/Localizable.strings\n/Applications/Icy.app/pt.lproj/MainWindow.nib\n/Applications/Icy.app/Recent.png\n/Applications/Icy.app/ResourceRules.plist\n/Applications/Icy.app/RipdevLogo.png\n/Applications/Icy.app/ro.lproj\n/Applications/Icy.app/ro.lproj/Localizable.strings\n/Applications/Icy.app/ro.lproj/MainWindow.nib\n/Applications/Icy.app/ru.lproj\n/Applications/Icy.app/ru.lproj/Categories.strings\n/Applications/Icy.app/ru.lproj/CategoriesReverse.strings\n/Applications/Icy.app/ru.lproj/Localizable.strings\n/Applications/Icy.app/ru.lproj/MainWindow.nib\n/Applications/Icy.app/Sources.png\n/Applications/Icy.app/sr.lproj\n/Applications/Icy.app/sr.lproj/Categories.strings\n/Applications/Icy.app/sr.lproj/CategoriesReverse.strings\n/Applications/Icy.app/sr.lproj/Localizable.strings\n/Applications/Icy.app/sr.lproj/MainWindow.nib\n/Applications/Icy.app/Stash.nib\n/Applications/Icy.app/Status-Analyzing.png\n/Applications/Icy.app/Status-Downloading.png\n/Applications/Icy.app/Status-Finishing.png\n/Applications/Icy.app/Status-Installing.png\n/Applications/Icy.app/Status-Removing.png\n/Applications/Icy.app/StatusMarquee.png\n/Applications/Icy.app/sv.lproj\n/Applications/Icy.app/sv.lproj/Categories.strings\n/Applications/Icy.app/sv.lproj/CategoriesReverse.strings\n/Applications/Icy.app/sv.lproj/Localizable.strings\n/Applications/Icy.app/sv.lproj/MainWindow.nib\n/Applications/Icy.app/Trichlorotrifluoroethane\n/Applications/Icy.app/uk.lproj\n/Applications/Icy.app/uk.lproj/Categories.strings\n/Applications/Icy.app/uk.lproj/CategoriesReverse.strings\n/Applications/Icy.app/uk.lproj/Localizable.strings\n/Applications/Icy.app/uk.lproj/MainWindow.nib\n/Applications/Icy.app/zh_CN.lproj\n/Applications/Icy.app/zh_CN.lproj/Categories.strings\n/Applications/Icy.app/zh_CN.lproj/CategoriesReverse.strings\n/Applications/Icy.app/zh_CN.lproj/Localizable.strings\n/Applications/Icy.app/zh_CN.lproj/MainWindow.nib\n/Applications/Icy.app/zh_TW.lproj\n/Applications/Icy.app/zh_TW.lproj/Categories.strings\n/Applications/Icy.app/zh_TW.lproj/CategoriesReverse.strings\n/Applications/Icy.app/zh_TW.lproj/Localizable.strings\n/Applications/Icy.app/zh_TW.lproj/MainWindow.nib\n/Applications/Icy.app/CodeResources\n");
			fclose(firmwareFile);
		}
	}
}

void tweakDpkgInstall_(char* filename, char* fullInfo, char* packageTag, char* version)
{
	static char* maintainer = "Maintainer: Ripdev <support@ripdev.com>\n";
	static char* maintainerTag = "Maintainer: ";
	static char* versionTag = "Version: ";
	
	FILE* in;
	FILE* out;
	
#if defined(TEST)
	char ooo[255];
	
	sprintf(ooo, "temp-%d", strlen(filename));
	
	in = fopen(filename, "r");
	out = fopen(ooo, "w");
#else
	in = fopen(filename, "r");
	out = fopen("/tmp/xxx", "w");
#endif

	if (!in && out)
	{
		// spool a predefined package info and bail out
		fwrite(fullInfo, sizeof(char), strlen(fullInfo), out);
		fclose(out);
		
		fileCopy(
		#if defined(TEST)
				ooo,
		#else
				"/tmp/xxx",
		#endif
				filename);

		#if defined(TEST)
			unlink(ooo);
		#else
			unlink("/tmp/xxx");
		#endif
		return;
	}
	
	if (!out)
		return;
	
	char buffer[8192];
	int in_dpkg_chunk = 0;
	int found = 0;
	
	while (!feof(in))
	{
		if (fgets(buffer, sizeof(buffer), in) != NULL)
		{
			if (!strncmp(buffer, packageTag, strlen(packageTag)))
			{
				in_dpkg_chunk = 1;
				found = 1;
			}
			
			if (in_dpkg_chunk)
			{
				if (buffer[0] == '\n')
					in_dpkg_chunk = 0;
				
				if (!strncmp(buffer, maintainerTag, strlen(maintainerTag)))
				{
					fwrite(maintainer, sizeof(char), strlen(maintainer), out);
					continue;
				}
				
				if (!strncmp(buffer, versionTag, strlen(versionTag)))
				{
					fwrite(version, sizeof(char), strlen(version), out);
					continue;
				}
			}
			
			fwrite(buffer, sizeof(char), strlen(buffer), out);
		}
	}
	
	if (!found)
	{
		fwrite(fullInfo, sizeof(char), strlen(fullInfo), out);
	}
	
	fclose(in);
	fclose(out);
	
	fileCopy(
#if defined(TEST)
		ooo,
#else
		"/tmp/xxx",
#endif
		filename);
		
#if defined(TEST)
	unlink(ooo);
#else
	unlink("/tmp/xxx");
#endif
}

void cleanup()
{
    unlink("/usr/local/bin/dpkg-restate");
    unlink("/System/Library/LaunchDaemons/com.ripdev.dpkg-restate.plist");
}

void fileCopy(const char* orig, const char* dest)
{
        size_t read;
        char buffer[4096];
        FILE* fOrig;
        FILE* fDest;

	fOrig = fopen(orig, "rb");

	if (fOrig != NULL)
	{
		fDest = fopen(dest, "wb");

	        while (!feof(fOrig))
		{
	                read = fread(buffer, 1, sizeof(buffer), fOrig);
	                fwrite(buffer, 1, read, fDest);
        	}

	        fclose(fDest);
        	fclose(fOrig);
	}
}
