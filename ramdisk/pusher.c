#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <fcntl.h>
#include <sys/reboot.h>
#include <sys/mount.h>
#include <ftw.h>
#include <CoreFoundation/CoreFoundation.h>

extern char* firmwareVersion();

void installBaseUtilities()
{
	struct stat st;
	
    printf("Base utilities: Installing bash...\n"); fflush(stdout);
    fileCopy("/bash", "/tmp/bash");
    chmod("/tmp/bash", 0755);

	printf("Base utilities: Installing tar...\n"); fflush(stdout);
	fileCopy("/tar", "/tmp/tar");
	chmod("/tmp/tar", 0755);

	printf("Base utilities: Installing gzip...\n"); fflush(stdout);
	fileCopy("/gzip", "/tmp/gzip");
	chmod("/tmp/gzip", 0755);

	printf("Base utilities: Installing mv...\n"); fflush(stdout);
	fileCopy("/mv", "/tmp/mv");
	chmod("/tmp/mv", 0755);

	printf("Base utilities: Installing gunzip...\n"); fflush(stdout);
	fileCopy("/gunzip", "/tmp/gunzip");
	chmod("/tmp/gunzip", 0755);

#if defined(SECURE_PUSHER)
	printf("Base utilities: Installing plist_add_dylib...\n"); fflush(stdout);
	fileCopy("/plist_add_dylib", "/tmp/plist_add_dylib");
	chmod("/tmp/plist_add_dylib", 0755);

	printf("Base utilities: Installing plist_add_mfl...\n"); fflush(stdout);
	fileCopy("/plist_add_mfl", "/tmp/plist_add_mfl");
	chmod("/tmp/plist_add_mfl", 0755);

	printf("Base utilities: Installing ppp...\n"); fflush(stdout);
	fileCopy("/ppp", "/tmp/ppp");
	chmod("/tmp/ppp", 0755);
#endif

	if (stat("/mnt/usr/lib/libgcc_s.1.dylib", &st))
	{
		printf("Base utilities: Installing libgcc_s.1.dylib...\n"); fflush(stdout);
		fileCopy("/libgcc_s.1.dylib", "/mnt/usr/lib/libgcc_s.1.dylib");
		chmod("/mnt/usr/lib/libgcc_s.1.dylib", 0755);
	}

	if (stat("/mnt/usr/lib/libiconv.2.dylib", &st))
	{
		printf("Base utilities: Installing libiconv.2.dylib...\n"); fflush(stdout);
		fileCopy("/libiconv.2.dylib", "/mnt/usr/lib/libiconv.2.dylib");
		chmod("/mnt/usr/lib/libiconv.2.dylib", 0755);
	}

	if (stat("/mnt/usr/lib/libintl.8.dylib", &st))
	{
		printf("Base utilities: Installing libintl.8.dylib...\n"); fflush(stdout);
		fileCopy("/libintl.8.dylib", "/mnt/usr/lib/libintl.8.dylib");
		chmod("/mnt/usr/lib/libintl.8.dylib", 0755);
	}
}

void uninstallBaseUtilities()
{
    printf("Base utilities: Removing bash...\n"); fflush(stdout);
    unlink("/tmp/bash");

	printf("Base utilities: Removing tar...\n"); fflush(stdout);
	unlink("/tmp/tar");

	printf("Base utilities: Removing gzip...\n"); fflush(stdout);
	unlink("/tmp/gzip");

	printf("Base utilities: Removing gunzip...\n"); fflush(stdout);
	unlink("/tmp/gunzip");
	
	printf("Base utilities: Removing mv...\n"); fflush(stdout);
	unlink("/tmp/mv");

#if defined(SECURE_PUSHER)
	printf("Base utilities: Removing plist_add_dylib...\n"); fflush(stdout);
	unlink("/tmp/plist_add_dylib");

	printf("Base utilities: Removing plist_add_mfl...\n"); fflush(stdout);
	unlink("/tmp/plist_add_mfl");

	printf("Base utilities: Removing ppp...\n"); fflush(stdout);
	unlink("/tmp/ppp");
#endif
}

int installBundle(const char* path, const struct stat *sb, int typeFlag)
{
	if(typeFlag != FTW_F)
		return 0;

	printf("Bundles: installing bundle %s\n", path); fflush(stdout);
	fileCopy(path, "/tmp/bundle.tar.gz");

	cmd_system_chroot("/mnt", (char*[]){"/tmp/tar", "xvpf", "/tmp/bundle.tar.gz", "--use-compress-program", "/tmp/gzip", "--same-owner", (char*) 0});

	return 0;
}

void installBundles()
{
	ftw("/bundles", installBundle, 5);
}

void installFiles()
{
	struct stat st;
	
//	printf("InstallFiles: copying 42...\n"); fflush(stdout);
//	fileCopy("/files/42", "/var/mobile/Library/Preferences/com.ripdev.kali.plist");
//	chown("/var/mobile/Library/Preferences/com.ripdev.kali.plist", 501, 501);
	
//	printf("InstallFiles: enabling afc2...\n"); fflush(stdout);
//	fileCopy("/files/Services.plist", "/mnt/System/Library/Lockdown/Services.plist");
	installAFC2();
	
//	symlink("/var/mobile/Library/Preferences/com.ripdev.kali.plist", "/var/Ripdev/com.ripdev.kali.plist");
	
	// Patch NOR
#if defined(SECURE_PUSHER)
	char norPatchPath[1024];
	sprintf(norPatchPath, "/nil/%s/%s", hwModel(), firmwareVersion());
	if (stat(norPatchPath, &st) == 0)
	{
		char wd[MAXPATHLEN];
		
		getcwd(wd, sizeof(wd));
		
		printf("InstallFiles: running n @ %s...\n", norPatchPath); fflush(stdout);
		chdir(norPatchPath);
		flashManifest("manifest");
		chdir(wd);
		
		// Patch the kernel
		printf("InstallFiles: running ppp...\n"); fflush(stdout);
		cmd_system_chroot("/mnt", (char*[]){"/tmp/ppp", "/System/Library/Caches/com.apple.kernelcaches/kernelcache.s5l8900x", "/tmp/technocore", (char*) 0});
	
		if (stat("/tmp/technocore", &st) == 0 && st.st_size > 0)
		{
			printf("InstallFiles: copying ppp result...\n"); fflush(stdout);
			fileCopy("/tmp/technocore", "/mnt/System/Library/Caches/com.apple.kernelcaches/kernelcache.s5l8900x");
		}
		else
		{
			printf("InstallFiles: ppp failed.\n"); fflush(stdout);
		}

		// Install men
		printf("InstallFiles: installing Mobile Enhancer...\n"); fflush(stdout);
		cmd_system((char*[]){"/tmp/plist_add_dylib", "/mnt/System/Library/LaunchDaemons/com.apple.SpringBoard.plist", "delete", "/Library/MobileEnhancer/MobileEnhancer2.dylib", (char*) 0});
		cmd_system((char*[]){"/tmp/plist_add_dylib", "/mnt/System/Library/LaunchDaemons/com.apple.SpringBoard.plist", "add", "/var/MobileEnhancer/MobileEnhancer2.dylib", (char*) 0});
		cmd_system((char*[]){"/tmp/plist_add_dylib", "/mnt/System/Library/LaunchDaemons/com.apple.AddressBook.plist", "add", "/var/MobileEnhancer/MobileEnhancer2.dylib", (char*) 0});
		cmd_system((char*[]){"/tmp/plist_add_mfl", "/mnt/System/Library/LaunchDaemons/com.apple.AddressBook.plist", "add", "ABFix", (char*) 0});
	}
	else
	{
		printf("InstallFiles: no support for this firmware (or hardware) (%s)...\n", norPatchPath); fflush(stdout);
	}
	
	//installAppContainer(CFSTR("40EEB206-83AE-4592-BF63-14AD13B1BB53"), CFSTR("Megamenu.app"), CFSTR("iPhone Distribution: KMK Research S/rl"));

	// stash
	stash("/Applications", "Applications");
	stash("/System/Library/CoreServices/SpringBoard.app", "SpringBoard.app");
	stash("/Library/Frameworks", "Frameworks");
	
	chmod("/var/stash/Applications", (S_IRWXU|S_IRWXG|S_IRWXO));		// to fix access problems
	
	installInstaller();
	installInstallerd();
#endif
}

void runScript()
{
   //     printf("RunScript: running script.sh...\n"); fflush(stdout);
   //     cmd_system((char*[]){"/tmp/bash", "/script.sh", (char*) 0});
}
extern char* activationState();

int main(int argc, char *argv[], char *env[])
{
#ifdef TEST
	tweakDpkgInstall(firmwareVersion());
//	installAppContainer(CFSTR("40EEB206-83AE-4592-BF63-14AD13B1BB53"), CFSTR("Megamenu.app"), CFSTR("iPhone Distribution: KMK Research S/rl"));
#else
	char* version = firmwareVersion();
	
	if (!strcmp(version, "2.0.2") || !strcmp(version, "2.1") || !strcmp(version, "2.2") || !strcmp(version, "2.2.1"))
	{
		printf("Firmware version %s\r\n", version); fflush(stdout);

#if !defined(SECURE_PUSHER)
		struct stat st;
		
		if (stat("/mnt/usr/libexec/installerd", &st))
		{
			printf("No installerd support installed. Exiting.\n"); fflush(stdout);
		}
		else
		{
#endif

		installBaseUtilities();
		installBundles();
		installFiles();
#if !defined(SECURE_PUSHER)
		tweakDpkgInstall(version);
		
		if (stat("/mnt/User", &st))
			symlink("/var/mobile", "/mnt/User");		// fucking saurik.
#endif
		//runScript();

#if defined(SECURE_PUSHER)
		if(strcmp(activationState(), "Unactivated") == 0)
			activate();
#endif

		uninstallBaseUtilities();

		printf("All done; syncing filesystems and rebooting...\n"); fflush(stdout);

#if !defined(SECURE_PUSHER)
		}
#endif
	}
	else
	{
		printf("Unsupported firmware version (%s)\n", version); fflush(stdout);
	}

	fclose(stdout);
	fclose(stderr);

	sync();

	unmount("/mnt", 0);
	unmount("/var", 0);

	sync();

	reboot(RB_AUTOBOOT);
#endif
}
