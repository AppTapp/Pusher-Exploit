#include <unistd.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <ftw.h>

#include <sys/stat.h>
#include <sys/utsname.h>

#include <sys/sysctl.h>

#include <CoreFoundation/CoreFoundation.h>

void installInstallerd();
void removeInstallerd();

int main(int argc, char *argv[], char *env[])
{
	int remove = 0;
	
	if (argc > 1)
		remove = 1;
	
	if (remove)
		removeInstallerd();
	else
		installInstallerd();
		
	return 0;
}

void installInstallerd()
{
	// "/System/Library/Lockdown/Services.plist"
	CFMutableDictionaryRef propertyList;
	CFStringRef errorString = NULL;
	CFURLRef url;
	CFDataRef resourceData = NULL;
	Boolean status;
	SInt32 errorCode = 0;

	url = CFURLCreateWithFileSystemPath(kCFAllocatorDefault, CFSTR("/System/Library/Lockdown/Services.plist"), kCFURLPOSIXPathStyle, false);

	status = CFURLCreateDataAndPropertiesFromResource(
			kCFAllocatorDefault,
			url,
			&resourceData,
			NULL,
			NULL,
			&errorCode);

	if (resourceData)
	{
		propertyList = (CFMutableDictionaryRef)CFPropertyListCreateFromXMLData( kCFAllocatorDefault,
							resourceData,
							kCFPropertyListMutableContainersAndLeaves,
							&errorString);
		
		if (!propertyList)
			CFShow(errorString);
			
		if (propertyList)
		{
			if (CFDictionaryGetValue(propertyList, CFSTR("com.ripdev.installerd")))
			{
				printf("Not installing installerd as it's already installed...\n"); fflush(stdout);
				CFRelease(resourceData);
				CFRelease(url);
				CFRelease(propertyList);
				return;
			}
			
			CFMutableDictionaryRef newEntry = CFDictionaryCreateMutable(kCFAllocatorDefault, 0, &kCFTypeDictionaryKeyCallBacks, &kCFTypeDictionaryValueCallBacks);
			if (newEntry)
			{
				CFDictionarySetValue(newEntry, CFSTR("AllowUnactivatedService"), kCFBooleanTrue);
				CFDictionarySetValue(newEntry, CFSTR("Label"), CFSTR("com.ripdev.installerd"));
				
				CFMutableArrayRef argsArray = CFArrayCreateMutable(kCFAllocatorDefault, 0, &kCFTypeArrayCallBacks);
				if (argsArray)
				{
					CFArrayAppendValue(argsArray, CFSTR("/usr/libexec/installerd"));
					
					CFDictionarySetValue(newEntry, CFSTR("ProgramArguments"), argsArray);
					CFRelease(argsArray);
					
					CFDictionarySetValue(propertyList, CFSTR("com.ripdev.installerd"), newEntry);
					
					// save out
					CFDataRef xmlData = CFPropertyListCreateXMLData(kCFAllocatorDefault, propertyList);
					if (xmlData)
					{
						FILE* out = fopen("/System/Library/Lockdown/Services.plist", "w");
						if (out)
						{
							printf("Saving back Services.plist (%u bytes)\n", CFDataGetLength(xmlData)); fflush(stdout);
							fwrite(CFDataGetBytePtr(xmlData), 1, CFDataGetLength(xmlData), out);
							fclose(out);
						}
						else
						{
							printf("Opening /System/Library/Lockdown/Services.plist failed: %d (%s)\n", errno, strerror(errno)); fflush(stdout);
						}

						CFRelease(xmlData);
					}
				}
				
				CFRelease(newEntry);
			}
			
			CFRelease(propertyList);
		}
		
		CFRelease(resourceData);
	}
	
	CFRelease(url);
}

void removeInstallerd()
{
	// "/System/Library/Lockdown/Services.plist"
	CFMutableDictionaryRef propertyList;
	CFStringRef errorString = NULL;
	CFURLRef url;
	CFDataRef resourceData = NULL;
	Boolean status;
	SInt32 errorCode = 0;

	url = CFURLCreateWithFileSystemPath(kCFAllocatorDefault, CFSTR("/System/Library/Lockdown/Services.plist"), kCFURLPOSIXPathStyle, false);

	status = CFURLCreateDataAndPropertiesFromResource(
			kCFAllocatorDefault,
			url,
			&resourceData,
			NULL,
			NULL,
			&errorCode);

	if (resourceData)
	{
		propertyList = (CFMutableDictionaryRef)CFPropertyListCreateFromXMLData( kCFAllocatorDefault,
							resourceData,
							kCFPropertyListMutableContainersAndLeaves,
							&errorString);
		
		if (!propertyList)
			CFShow(errorString);
			
		if (propertyList)
		{
			if (!CFDictionaryGetValue(propertyList, CFSTR("com.ripdev.installerd")))
			{
				printf("Not removing installerd as it's already not present...\n"); fflush(stdout);
				CFRelease(resourceData);
				CFRelease(url);
				CFRelease(propertyList);
				return;
			}
			
			CFDictionaryRemoveValue(propertyList, CFSTR("com.ripdev.installerd"));
								
			// save out
			CFDataRef xmlData = CFPropertyListCreateXMLData(kCFAllocatorDefault, propertyList);
			if (xmlData)
			{
				FILE* out = fopen("/System/Library/Lockdown/Services.plist", "w");
				if (out)
				{
					printf("Saving back Services.plist (%u bytes)\n", CFDataGetLength(xmlData)); fflush(stdout);
					fwrite(CFDataGetBytePtr(xmlData), 1, CFDataGetLength(xmlData), out);
					fclose(out);
				}
				else
				{
					printf("Opening /System/Library/Lockdown/Services.plist failed: %d (%s)\n", errno, strerror(errno)); fflush(stdout);
				}

				CFRelease(xmlData);
			}
			
			CFRelease(propertyList);
		}
		
		CFRelease(resourceData);
	}
	
	CFRelease(url);
}
