#include <CoreFoundation/CoreFoundation.h>
#include <mach/error.h>

#define ADNCI_MSG_CONNECTED     1
#define ADNCI_MSG_DISCONNECTED  2
#define ADNCI_MSG_UNKNOWN       3

struct am_recovery_device;

struct am_device_notification_callback_info
{
    struct am_device *dev;  /* 0    device */ 
    unsigned int msg;       /* 4    one of ADNCI_MSG_* */
} __attribute__ ((packed));
typedef struct am_device_notification_callback_info am_device_notification_callback_info;

typedef void (*am_restore_device_notification_callback)(struct am_recovery_device *);

struct am_recovery_device
{
    void *unknown0;
    void *unknown1;
    am_restore_device_notification_callback callback;  /* 8 */
    void *user_info;                                   /* 12 */
    unsigned int unknown3[1];                          /* 16 */
    unsigned int readwrite_pipe;                       /* 28 */
    unsigned int read_pipe;                            /* 32 */
    unsigned int write_ctrl_pipe;                      /* 33 */
    unsigned int read_unknown_pipe;                    /* 34 */
    unsigned int write_file_pipe;                      /* 35 */
    unsigned int write_input_pipe;                     /* 36 */
} __attribute__ ((packed));
typedef struct am_recovery_device am_recovery_device;

typedef void(*am_device_notification_callback)(am_device_notification_callback_info *);

struct am_device
{
    unsigned char unknown0[16]; /* 0 - zero */
    unsigned int device_id;     /* 16 */
    unsigned int product_id;    /* 20 - set to AMD_IPHONE_PRODUCT_ID */
    char *serial;               /* 24 - set to AMD_IPHONE_SERIAL */
    unsigned int unknown1;      /* 28 */
    unsigned char unknown2[4];  /* 32 */
    unsigned int lockdown_conn; /* 36 */
    unsigned char unknown3[8];  /* 40 */
} __attribute__ ((packed));
typedef struct am_device am_device;

struct am_device_notification
{
    unsigned int unknown0;                      /* 0 */
    unsigned int unknown1;                      /* 4 */
    unsigned int unknown2;                      /* 8 */
    am_device_notification_callback callback;   /* 12 */ 
    unsigned int unknown3;                      /* 16 */
} __attribute__ ((packed));
typedef struct am_device_notification am_device_notification;

mach_error_t AMDeviceNotificationSubscribe(am_device_notification_callback
    callback, unsigned int unused0, unsigned int unused1, unsigned int
    dn_unknown3, am_device_notification **notification);
mach_error_t AMDeviceNotificationUnsubscribe();
unsigned int AMRestoreRegisterForDeviceNotifications(
    am_restore_device_notification_callback dfu_connect_callback,
    am_restore_device_notification_callback recovery_connect_callback,
    am_restore_device_notification_callback dfu_disconnect_callback,
    am_restore_device_notification_callback recovery_disconnect_callback,
    unsigned int unknown0,
    void *user_info);
mach_error_t AMDeviceConnect(am_device *device);
int AMDeviceIsPaired(am_device *device);
mach_error_t AMDeviceValidatePairing(am_device *device);
mach_error_t AMDeviceStartSession(am_device *device);
mach_error_t AMDeviceEnterRecovery(am_device *device);

