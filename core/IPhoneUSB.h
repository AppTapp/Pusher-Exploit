/*!
 @header IPhoneUSB.h
 @project Pusher
 @author Alexander Maksimenko
 @copyright Copyright (c) 2009 Ripdev. All rights reserved.
 */

#import <CoreFoundation/CFNumber.h>
#import <IOKit/IOKitLib.h>
#import <IOKit/IOCFPlugIn.h>
#import <IOKit/usb/IOUSBLib.h>

/* DFU commands */
#define DFU_DETACH      0
#define DFU_DNLOAD      1
#define DFU_UPLOAD      2
#define DFU_GETSTATUS   3
#define DFU_CLRSTATUS   4
#define DFU_GETSTATE    5
#define DFU_ABORT       6

/* DFU states */
#define DFU_STATE_APP_IDLE                  0x00
#define DFU_STATE_APP_DETACH                0x01
#define DFU_STATE_DFU_IDLE                  0x02
#define DFU_STATE_DFU_DOWNLOAD_SYNC         0x03
#define DFU_STATE_DFU_DOWNLOAD_BUSY         0x04
#define DFU_STATE_DFU_DOWNLOAD_IDLE         0x05
#define DFU_STATE_DFU_MANIFEST_SYNC         0x06
#define DFU_STATE_DFU_MANIFEST              0x07
#define DFU_STATE_DFU_MANIFEST_WAIT_RESET   0x08
#define DFU_STATE_DFU_UPLOAD_IDLE           0x09
#define DFU_STATE_DFU_ERROR                 0x0a

/* DFU status */
#define DFU_STATUS_OK                   0x00
#define DFU_STATUS_ERROR_TARGET         0x01
#define DFU_STATUS_ERROR_FILE           0x02
#define DFU_STATUS_ERROR_WRITE          0x03
#define DFU_STATUS_ERROR_ERASE          0x04
#define DFU_STATUS_ERROR_CHECK_ERASED   0x05
#define DFU_STATUS_ERROR_PROG           0x06
#define DFU_STATUS_ERROR_VERIFY         0x07
#define DFU_STATUS_ERROR_ADDRESS        0x08
#define DFU_STATUS_ERROR_NOTDONE        0x09
#define DFU_STATUS_ERROR_FIRMWARE       0x0a
#define DFU_STATUS_ERROR_VENDOR         0x0b
#define DFU_STATUS_ERROR_USBR           0x0c
#define DFU_STATUS_ERROR_POR            0x0d
#define DFU_STATUS_ERROR_UNKNOWN        0x0e
#define DFU_STATUS_ERROR_STALLEDPKT     0x0f

typedef struct
{
    unsigned char bStatus;
    unsigned int  bwPollTimeout;
    unsigned char bState;
    unsigned char iString;
} dfu_status;

@protocol IPhoneDelegateProtocol

-(void) processIPodNormalConnected:(id) sender;
-(void) processIPhoneNormalConnected:(id) sender;
-(void) processIPhone3GNormalConnected:(id) sender;
-(void) processIPhoneRecoveryConnected:(id) sender;
-(void) processIPhoneRecovery2Connected:(id) sender;
-(void) processIPhoneDFUConnected:(id) sender;
-(void) processIPhoneDFU2Connected:(id) sender;

-(void) processIPodNormal:(id) sender;
-(void) processIPhoneNormal:(id) sender;
-(void) processIPhone3GNormal:(id) sender;
-(void) processIPhoneRecovery:(id) sender;
-(void) processIPhoneRecovery2:(id) sender;
-(void) processIPhoneDFU:(id) sender;
-(void) processIPhoneDFU2:(id) sender;

-(void) processIPodNormalDisconnected:(id) sender;
-(void) processIPhoneNormalDisconnected:(id) sender;
-(void) processIPhoneRecoveryDisconnected:(id) sender;
-(void) processIPhoneDFUDisconnected:(id) sender;
-(void) processIPhoneDFU2Disconnected:(id) sender;

-(void) processBeginUpload:(unsigned long long) bytes;
-(void) processUploaded:(unsigned long long) bytes;

-(void) processIPhoneError:(NSString*) err :(id) sender;
-(void) processIPhoneMsg:(NSString*) msg :(id) sender;

@end

@interface IPhoneUSB : NSObject
{
	enum
	{
        DisconnectMode = 0,
		IPodNormalMode,
		IPhoneNormalMode,
		IPhone3GNormalMode,
		RecoveryMode,
		Recovery2Mode,        
		DFUMode,
        DFU2Mode
	} USBMode;

	IONotificationPortRef _ioKitNotificationPort;
	CFRunLoopSourceRef _notificationRunLoopSource;

	id<IPhoneDelegateProtocol> _delegate;
	
	IOUSBDeviceInterface** _dev;
	IOUSBInterfaceInterface** _intf;
    NSLock* _lock;
    
	int _mode;
	BOOL _enabled;
    BOOL _newInterface;
	
	UInt8 _ctrlIn;
	UInt8 _ctrlOut;

	UInt8 _serialIn;
	UInt8 _serialOut;

	UInt8 _fileIn;
	UInt8 _fileOut;

    unsigned short _transaction;

    BOOL _usbNotificationsOnly;
}

-(id) delegate;
-(void) setDelegate:(id) delegate;

-(void) ioKitSetUp;
-(void) ioKitTearDown;

-(void) restartService;
-(void) startService;
-(void) stopService;
-(BOOL) serviceStatus;

-(void) registerForUSBNotifications;
-(void) usbDeviceAdded:(io_iterator_t) iterator;
-(void) usbDeviceRemoved:(io_iterator_t) iterator;

-(void) ifIPhoneRemoved:(io_object_t) device;
-(void) ifIPhoneAdded:(io_object_t) device;

-(void) dealWithDevice;
-(void) dealWithInterface:(io_service_t) usbInterfaceRef;

- (void)enableUSBNotificationOnlyMode;

@end

@interface IPhoneUSB (IPhoneIO)

-(IOReturn) resetDevice;

-(IOReturn) writeSerial:(void*) data :(unsigned int) size;
-(IOReturn) readSerial:(void*) data :(unsigned int*) pSize;

-(IOReturn) sendRequest:(IOUSBDevRequest*) request;
-(IOReturn) sendCommand:(NSString*) cmd;

-(void) uploadFile:(NSString*) file;
-(dfu_status) uploadFileChunk:(void*) buf :(unsigned short) length;
-(IOReturn) dfuAbort;
-(dfu_status) dfuStatus;
-(IOReturn) dfuClearStatus;
-(NSString*) stringForDFUStatus:(int) status;

@end