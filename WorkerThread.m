/*!
 @source WorkerThread.m
 @project Pusher
 @author Alexander Maksimenko
 @copyright Copyright (c) 2009 Ripdev. All rights reserved.
 */

#import "WorkerThread.h"

@implementation WorkerThread

-(id) init
{
    self = [super init];

    _port = nil;

    return self;
}

-(void) dealloc
{
    [_port release];
   
    [super dealloc];
}

-(void) instanceThreadMethod:(NSDictionary*) dict
{
    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
 
    @try
    {
        _port = [[dict objectForKey:MachPortKey] retain];
        
		[self checkinThread];
        [self threadTask:dict];
    }
    @catch (NSException *ex)
    {
        Log(@"%@ %@", [ex name], [ex reason]);
    }
    @finally
    {
        [pool release];
    }
}

-(void) checkinThread
{
	NSPort* port = [NSMachPort port];
	if(port)
	{
		[port setDelegate:self];
		[[NSRunLoop currentRunLoop] addPort:port forMode:NSDefaultRunLoopMode];
		
		NSPortMessage* msg = [[NSPortMessage alloc] initWithSendPort:_port receivePort:port components:nil];
		if(msg)
		{
			[msg setMsgid:ThreadStartMessage];
			[msg sendBeforeDate:[NSDate date]];
		}
	}
}

-(void) threadTask:(NSDictionary*) dict
{

}

-(void) startSun
{
    [self sendMessage:SunStartMessage withData:nil];
}

-(void) stopSun
{
    [self sendMessage:SunStopMessage withData:nil];
}

-(void) setText:(NSString*) text
{
    [InstanceManager setText:text];
}

-(void) sendMessage:(int) msg withData:(NSData*) data
{
    NSPortMessage* portMessage = [[NSPortMessage alloc] initWithSendPort:_port receivePort:nil components:(data == nil ? nil : [NSArray arrayWithObject:data])];

    if(msg)
    {
		[portMessage setMsgid:msg];
		
		BOOL res = FALSE;

		while(!res)
			res = [portMessage sendBeforeDate:[NSDate date]];
			
		if(!res)
			Log(@"Failed to send port message: %d\n", portMessage);
    }
}

@end
